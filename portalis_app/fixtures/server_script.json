[
 {
  "allow_guest": 0,
  "api_method": "generate_intake_packet",
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-12 08:51:47.167238",
  "module": null,
  "name": "New Intake Packet",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Case",
  "script": "# Server Script: New Intake Packet\n# DocType: HRSN Case (or wherver you trigger it)\n# API Type: (likely \"Server\" or \"API\" depending on how you call it)\n\nimport frappe\nfrom frappe.utils import getdate\n\n# 1. Fetch the Case\ncase_name = frappe.form_dict.get(\"case_name\")\nif not case_name:\n    frappe.throw(\"Missing case_name in request.\")\n\ncase_doc = frappe.get_doc(\"HRSN Case\", case_name)\n\n# 2. Check for existing Draft Intake for this case\nexists = frappe.db.exists(\n    \"Client Intake Form\",\n    {\"hrsn_case\": case_name, \"docstatus\": 0}\n)\n\nif exists:\n    frappe.msgprint(\"A Draft Intake Form is already waiting for this client.\")\n    raise SystemExit\n\n# 3. Create the Intake Form (staging document)\nnew_form = frappe.new_doc(\"Client Intake Form\")\n\n# ----------------------------------------------------------------------\n# 3A. Basic linkage\n# ----------------------------------------------------------------------\nnew_form.hrsn_case = case_doc.name\n# You’re already using client_name as a display field; keep behavior the same\nnew_form.client_name = case_doc.client_link\n\n# ----------------------------------------------------------------------\n# 3B. Prefill contact + address from Case (where we know the fieldnames)\n# ----------------------------------------------------------------------\n\n# Phone: based on your synch script (intake.phone → case.client_phone)\nif getattr(case_doc, \"client_phone\", None):\n    new_form.phone = case_doc.client_phone\n\n# Physical vs mailing – you currently map intake.current_address → case.current_physical_address\n# For prefill, we reverse that.\nif getattr(case_doc, \"current_physical_address\", None):\n    new_form.current_address = case_doc.current_physical_address\n\n# Mailing address → mailing_address on intake form (you already map mailing to case earlier)\nif getattr(case_doc, \"current_mailing_address\", None):\n    new_form.mailing_address = case_doc.current_mailing_address\n\n# ----------------------------------------------------------------------\n# 3C. Prefill housing configuration (mirror of synch_intake_to_case)\n# ----------------------------------------------------------------------\n\n# These assignments are symmetric to the ones in synch_intake_to_case\nfor src, dest in [\n    (\"housing_county\", \"housing_county\"),\n    (\"current_housing_status\", \"current_housing_status\"),\n    (\"bedroom_count\", \"bedroom_count\"),\n    (\"monthly_rent_amount\", \"monthly_rent_amount\"),\n    (\"has_active_lease\", \"has_active_lease\"),\n    (\"past_due_rent\", \"past_due_rent\"),\n    (\"months_past_due\", \"months_past_due\"),\n    (\"months_in_arrears\", \"months_arrears\"),  # Note: intake uses months_arrears\n    (\"has_eviction_notice\", \"eviction_status\"),\n]:\n    value = getattr(case_doc, src, None)\n    if value is not None:\n        setattr(new_form, dest, value)\n\n# ----------------------------------------------------------------------\n# 3D. Prefill landlord + service flags\n# ----------------------------------------------------------------------\n\nfor src, dest in [\n    (\"landlord_phone\", \"landlord_phone\"),\n    (\"landlord_email\", \"landlord_email\"),\n]:\n    value = getattr(case_doc, src, None)\n    if value:\n        setattr(new_form, dest, value)\n\n# Service request flags (same names as in synch_intake_to_case)\nif getattr(case_doc, \"rent_assistance\", None) is not None:\n    new_form.rent_assistance = case_doc.rent_assistance\n\nif getattr(case_doc, \"utility_services\", None) is not None:\n    new_form.utility_services = case_doc.utility_services\n\nif getattr(case_doc, \"tenancy_support__required_for_rentutilitiesstorage\", None) is not None:\n    new_form.tenancy_support = case_doc.tenancy_support__required_for_rentutilitiesstorage\n\n# ----------------------------------------------------------------------\n# 3E. Prefill consents / ROI where present\n# ----------------------------------------------------------------------\n\nfor src, dest in [\n    (\"agree_to_release_mh_info\", \"agree_to_release_mh_info\"),\n    (\"agree_to_release_da_info\", \"agree_to_release_da_info\"),\n    (\"consent_to_data_sharing\", \"consent_to_data_sharing\"),\n    (\"roi_expiration\", \"roi_expiration\"),\n    (\"roi_expiration_date\", \"roi_expiration_date\"),\n    (\"attest_no_duplicate\", \"attest_no_duplicate\"),\n    (\"agree_to_services\", \"agree_to_services\"),\n    (\"other_authorized_party\", \"other_authorized_party\"),\n    (\"roi_limitations\", \"roi_limitations\"),\n]:\n    value = getattr(case_doc, src, None)\n    if value is not None:\n        setattr(new_form, dest, value)\n\n# If you want to prefill participant_signature to show them what you have on file:\nif getattr(case_doc, \"participant_signature\", None):\n    new_form.attestation_signature = case_doc.participant_signature\n\n# ----------------------------------------------------------------------\n# 3F. Prefill referral info (if using the new HRSN Referrals child table)\n# ----------------------------------------------------------------------\n\n# We do NOT assume a child-table fieldname on HRSN Case; we try a couple of\n# likely ones, and if none exist, we simply skip this block.\nreferral_rows = None\nreferrals_fieldname = None\n\nfor fieldname in (\"referrals\", \"hrsn_referrals\"):\n    rows = getattr(case_doc, fieldname, None)\n    if rows:\n        referral_rows = rows\n        referrals_fieldname = fieldname\n        break\n\nif referral_rows:\n    # Use the first (or most recent) referral row to prefill intake fields\n    # You can change the selection logic if you later add statuses.\n    referral = referral_rows[0]\n\n    if getattr(referral, \"uniteus_referral_id\", None):\n        new_form.uniteus_referral_id = referral.uniteus_referral_id\n\n    if getattr(referral, \"cco\", None):\n        new_form.cco = referral.cco\n\n# ----------------------------------------------------------------------\n# 4. Map the Household Table (as you already had it)\n# ----------------------------------------------------------------------\n\nif getattr(case_doc, \"household_member_detail\", None):\n    for member in case_doc.household_member_detail:\n        new_form.append(\"household_members\", {\n            \"member_name\": member.member_name,\n            \"member_dob\": member.member_dob,\n            \"relationship\": member.relationship,\n        })\n\n# ----------------------------------------------------------------------\n# 5. Assign Intake Form to the client’s portal user\n# ----------------------------------------------------------------------\n\nclient_user = frappe.db.get_value(\"Client\", case_doc.client_link, \"portal_user\")\n\nif not client_user:\n    frappe.throw(\"This Client does not have a Portal User linked. Please link a User in the Client record first.\")\n\nnew_form.owner = client_user\nnew_form.save(ignore_permissions=True)\n\nfrappe.msgprint(f\"Packet generated for {client_user}. Status: Draft.\")\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-17 13:20:14.943167",
  "module": null,
  "name": "Retroactive Date Validation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Service Authorization",
  "script": "# Server Script: DocType Event > Before Save\nfrom frappe.utils import add_months, getdate, nowdate\n\n# Configuration\nretro_limit_months = 2\n\n# Make sure these match the actual `service_category` values on this DocType\nvalid_retro_types = [\n    \"Rent Assistance\",\n    \"Utility Assistance\",\n    \"Storage Support\",          # or \"Storage Assistance\" if that is your exact label\n]\n\nif doc.service_category in valid_retro_types and doc.start_date:\n    start_date = getdate(doc.start_date)\n    today = getdate(nowdate())\n    \n    # Calculate the limit date (1st of the month, 2 months ago)\n    # Example: if today is Nov 25, limit is Sept 1.\n    limit_date = add_months(today, -retro_limit_months).replace(day=1)\n    \n    # 1. Check Retroactive Limit\n    if start_date < limit_date:\n        frappe.throw(\n            f\"<b>Compliance Error:</b> {doc.service_category} cannot be backdated prior to \"\n            f\"{limit_date.strftime('%b %d, %Y')}. \"\n            f\"You attempted to set it to {start_date.strftime('%b %d, %Y')}.\"\n        )\n\n    # 2. Align to first of month (optional rule)\n    if start_date.day != 1:\n        frappe.msgprint(\"Note: Adjusting Start Date to the 1st of the month for compliance.\")\n        doc.effective.start_date = effective.start_date.replace(day=1)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-12 09:48:42.726325",
  "module": null,
  "name": "Hide Active but Completed Cases from Intake",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Case",
  "script": "# Server Script: Permission Query > HRSN Case\r\n# Purpose: The \"Trap Door\". Hides cases from Intake Specialists once they move to \"Active Case Mgmt\".\r\n\r\n# 1. Check Roles directly using the database (This bypasses the error)\r\nis_intake = frappe.db.exists(\"Has Role\", {\"parent\": user, \"role\": \"Intake Specialist\"})\r\nis_manager = frappe.db.exists(\"Has Role\", {\"parent\": user, \"role\": \"Program Manager\"})\r\nis_admin   = frappe.db.exists(\"Has Role\", {\"parent\": user, \"role\": \"System Manager\"})\r\n\r\n# 2. Check Logic:\r\n# IF user is 'Intake Specialist' AND NOT 'Program Manager' AND NOT 'System Manager'\r\nif is_intake and not is_manager and not is_admin:\r\n    conditions = \"service_status NOT IN ('Active Case Mgmt', 'Closed')\"\r\nelse:\r\n    conditions = \"\"",
  "script_type": "Permission Query"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-12 09:38:58.137819",
  "module": null,
  "name": "Validation",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Activity Log",
  "script": "# Server Script: HRSN Activity Log > Before Save\n\nimport frappe\nfrom frappe.utils import flt\n\n# 1. Fetch Parent Case Data for Modifiers\n# This Activity Log is a child table on HRSN Case\ncase = frappe.get_doc(\"HRSN Case\", doc.parent)\n\n# 2. Auto-Apply Modifiers (U1 is Mandatory)\nmods = [\"U1\"]\n\n# Add Housing Modifier (U2/U3/U4) from Case if it exists\nif case.housing_modifier:\n    mods.append(case.housing_modifier)\n\ndoc.modifier = \", \".join(mods)\n\n# 3. Enforce Time Limits\n\n# Fetch all other logs for THIS Case on THIS Date\ndaily_logs = frappe.get_all(\n    \"HRSN Activity Log\",\n    filters={\n        \"parent\": doc.parent,\n        \"date_of_service\": doc.date_of_service,\n        \"name\": [\"!=\", doc.name],\n    },\n    fields=[\"time_spent\", \"is_travel_time\"],\n)\n\n# Normalize current row's time_spent\nthis_time = flt(doc.time_spent or 0)\n\ntotal_mins = this_time\ntravel_mins = this_time if doc.is_travel_time else 0\n\nfor log in daily_logs:\n    log_time = flt(log.time_spent or 0)\n    total_mins += log_time\n    if log.is_travel_time:\n        travel_mins += log_time\n\n# Rule: Max 6 Hours (360 mins) Total\nif total_mins > 360:\n    frappe.throw(\n        f\"Daily Limit Exceeded: OHA limits services to 6 hours per day. \"\n        f\"Total: {total_mins / 60} hrs.\"\n    )\n\n# Rule: Max 3 Hours (180 mins) Travel\nif travel_mins > 180:\n    frappe.throw(\n        f\"Travel Limit Exceeded: OHA limits travel to 3 hours per day. \"\n        f\"Total: {travel_mins / 60} hrs.\"\n    )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-26 08:18:11.690640",
  "module": null,
  "name": "Fee Schedule Engine",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Case",
  "script": "# Server Script: HRSN Case > Before Save\r\n\r\n# --- 1. CONFIGURATION: OHA Fee Schedule & Regions ---\r\n\r\n# Region Map based on OHA Housing Fee Schedule definitions\r\nregion_map = {\r\n    \"Clackamas\": \"Region A\", \"Columbia\": \"Region A\", \"Multnomah\": \"Region A\",\r\n    \"Washington\": \"Region A\", \"Yamhill\": \"Region A\",\r\n    \"Benton\": \"Region B\", \"Deschutes\": \"Region B\", \"Hood River\": \"Region B\",\r\n    \"Wasco\": \"Region B\",\r\n    \"Lane\": \"Region C\", \"Marion\": \"Region C\", \"Polk\": \"Region C\",\r\n    \"Jackson\": \"Region D\", \"Josephine\": \"Region D\", \"Linn\": \"Region D\"\r\n}\r\n\r\n# UPL Matrix: Maximum Monthly Rent by Region & Bedroom Count\r\n# Source: Housing Fee Schedule - Rent and Utilities \r\nupl_matrix = {\r\n    \"Region A\": { \"0-1 Bedroom\": 1780.00, \"2 Bedrooms\": 2025.00, \"3+ Bedrooms\": 2810.00 },\r\n    \"Region B\": { \"0-1 Bedroom\": 1390.00, \"2 Bedrooms\": 1825.00, \"3+ Bedrooms\": 2570.00 },\r\n    \"Region C\": { \"0-1 Bedroom\": 1125.00, \"2 Bedrooms\": 1400.00, \"3+ Bedrooms\": 1970.00 },\r\n    \"Region D\": { \"0-1 Bedroom\": 960.00,  \"2 Bedrooms\": 1175.00, \"3+ Bedrooms\": 1655.00 },\r\n    \"Region E\": { \"0-1 Bedroom\": 795.00,  \"2 Bedrooms\": 980.00,  \"3+ Bedrooms\": 1380.00 },\r\n}\r\n\r\n# Modifier Map: Converts Bedroom Count to Billing Modifier\r\nmodifier_map = {\r\n    \"0-1 Bedroom\": \"U2\",\r\n    \"2 Bedrooms\": \"U3\",\r\n    \"3+ Bedrooms\": \"U4\"\r\n}\r\n\r\n# --- 2. LOGIC: Update Parent Case ---\r\n\r\n# A. Determine Region Code\r\n# If county is not in the list, default to \"Region E\" (Lowest UPL)\r\nif doc.housing_county:\r\n    doc.region_code = region_map.get(doc.housing_county, \"Region E\")\r\n\r\n# B. Determine Housing Modifier (U2/U3/U4)\r\nif doc.bedroom_count:\r\n    doc.housing_modifier = modifier_map.get(doc.bedroom_count)\r\n\r\n# --- 3. LOGIC: Process Child Table (Service Authorizations) ---\r\n\r\nif doc.region_code and doc.bedroom_count and doc.service_authorizations:\r\n    # Get the Max Rent for this specific client's situation\r\n    client_max_rent = upl_matrix.get(doc.region_code, {}).get(doc.bedroom_count, 0)\r\n\r\n    for row in doc.service_authorizations:\r\n\r\n        # --- SCENARIO 1: RENT ASSISTANCE ---\r\n        if row.service_category == \"Rent Assistance\":\r\n            row.procedure_code = \"H0044\"\r\n            row.upl_limit = client_max_rent\r\n\r\n            # Calculate Billable Amount: The LOWER of Actual Cost vs. UPL\r\n            if row.actual_cost > 0:\r\n                row.billable_amount = min(row.actual_cost, client_max_rent)\r\n            else:\r\n                row.billable_amount = 0\r\n\r\n            # Set Modifiers: U1 (Program) + Housing Modifier (U2/U3/U4)\r\n            mod_list = [\"U1\"]\r\n            if doc.housing_modifier:\r\n                mod_list.append(doc.housing_modifier)\r\n            row.modifiers = \", \".join(mod_list)\r\n\r\n        # --- SCENARIO 2: UTILITY ASSISTANCE ---\r\n        elif row.service_category == \"Utility Assistance\":\r\n            row.procedure_code = \"T2035\"\r\n            \r\n            # Note: Utilities Arrears is U1 only. Utilities Set-Up is U1 + U2-U4.\r\n            # For now, we default to U1 to ensure the claim is accepted.\r\n            row.modifiers = \"U1\" \r\n            \r\n            # For utilities, we generally pay the actual bill amount (UPL varies by Arrears vs Setup)\r\n            row.billable_amount = row.actual_cost\r\n            row.upl_limit = 0 \r\n\r\n        # --- SCENARIO 3: TENANCY SUPPORT ---\r\n        elif row.service_category == \"Tenancy Support\":\r\n            row.procedure_code = \"H2015\"\r\n            row.modifiers = \"U1\"\r\n            # Tenancy is billed by time (15-min units), not a monthly budget cap\r\n            row.upl_limit = 0\r\n            row.billable_amount = 0",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-12 09:28:42.403633",
  "module": null,
  "name": "Auto-File Client Documents",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Client Document Submission",
  "script": "import frappe\n\nif doc.hrsn_case and doc.attachment:\n    # Avoid creating duplicate File records for the same URL + case\n    existing_file_name = doc.attachment.split(\"/\")[-1] if \"/\" in doc.attachment else doc.attachment\n\n    existing = frappe.db.exists(\n        \"File\",\n        {\n            \"file_url\": doc.attachment,\n            \"attached_to_doctype\": \"HRSN Case\",\n            \"attached_to_name\": doc.hrsn_case,\n        },\n    )\n\n    if not existing:\n        file_doc = frappe.new_doc(\"File\")\n        file_doc.file_name = existing_file_name or \"Client Document\"\n        file_doc.file_url = doc.attachment\n        file_doc.attached_to_doctype = \"HRSN Case\"\n        file_doc.attached_to_name = doc.hrsn_case\n        file_doc.is_private = 1\n        file_doc.save(ignore_permissions=True)\n\n    # Always add a comment so staff see that a document was (re)submitted\n    case_doc = frappe.get_doc(\"HRSN Case\", doc.hrsn_case)\n    case_doc.add_comment(\n        \"Comment\",\n        f\"New document received: client uploaded a {doc.document_type} for {doc.submission_month or 'Review'}.\"\n    )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-17 13:17:12.111843",
  "module": "Client Management",
  "name": "Client Email",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Client",
  "script": "import frappe\n\n# This runs every time a Client is saved\nif doc.email:\n    # Look for another Client with the same email\n    existing = frappe.db.exists(\n        \"Client\",\n        [\n            [\"email\", \"=\", doc.email],\n            [\"name\", \"!=\", doc.name],  # exclude this same record if editing\n        ],\n    )\n\n    if existing:\n        frappe.throw(\n            f\"Email {doc.email} is already used for another Client ({existing}). \"\n            \"Please use a different email, or leave it blank if the client has no email.\"\n        )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-19 12:01:11.196716",
  "module": "Client Management",
  "name": "Case Management Handoff",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Case",
  "script": "import frappe\nfrom frappe.utils import now_datetime\n\nALLOWED_ROLES = (\"Intake Specialist\", \"Program Manager\")\nTARGET_STATUS = \"Active Case Mgmt\"\n\nINTAKE_DOCTYPES = (\n    (\"Client Intake Form - About Me\", \"About Me\"),\n    (\"Client Intake Form - Housing and Utilities\", \"Housing & Utilities\"),\n    (\"Client Intake Form - Income\", \"Income\"),\n    (\"Client Intake Form - ROI Attestations and Certifications\", \"ROI / Attestations\"),\n)\n\ndef user_has_allowed_role():\n    if frappe.session.user == \"Guest\":\n        return False\n    return any(frappe.has_role(r) for r in ALLOWED_ROLES)\n\ndef is_empty(val):\n    return val is None or (isinstance(val, str) and val.strip() == \"\")\n\ndef get_latest_intake_for_case(intake_doctype, case_name):\n    rows = frappe.get_all(\n        intake_doctype,\n        filters={\"hrsn_case\": case_name},\n        fields=[\"name\", \"modified\", \"intake_status\", \"workflow_state\"],\n        order_by=\"modified desc\",\n        limit_page_length=1,\n    )\n    return rows[0] if rows else None\n\ndef get_intake_status(row):\n    s = row.get(\"intake_status\")\n    if not is_empty(s):\n        return s\n    s = row.get(\"workflow_state\")\n    if not is_empty(s):\n        return s\n    return None\n\ndef validate_all_intakes_synced(case_name):\n    missing = []\n    details = []\n\n    for doctype, label in INTAKE_DOCTYPES:\n        latest = get_latest_intake_for_case(doctype, case_name)\n        if not latest:\n            missing.append(label)\n            details.append(f\"{label}: no intake record found\")\n            continue\n\n        status = get_intake_status(latest) or \"(blank)\"\n        if status != \"Synced\":\n            missing.append(label)\n            details.append(f\"{label}: latest is {doctype} {latest['name']} with status '{status}'\")\n\n    if missing:\n        frappe.throw(\n            \"Cannot move to Case Management. The following intake sections must be Synced:\\n\"\n            + \"\\n\".join([f\"- {m}\" for m in missing])\n            + \"\\n\\nDetails:\\n\"\n            + \"\\n\".join([f\"- {d}\" for d in details])\n        )\n\ndef main():\n    new_status = getattr(doc, \"service_status\", None)\n\n    # Only enforce when moving into Case Management status\n    if new_status != TARGET_STATUS:\n        return\n\n    # Only enforce on transition into that status (not every save)\n    old_status = None\n    if doc.name and not doc.is_new():\n        old_status = frappe.db.get_value(\"HRSN Case\", doc.name, \"service_status\")\n\n    if old_status == TARGET_STATUS:\n        return\n\n    # Optional: restrict who can perform the handoff\n    if not user_has_allowed_role():\n        frappe.throw(\"Only Intake Specialist or Program Manager may move a case to Case Management.\")\n\n    validate_all_intakes_synced(doc.name)\n\n    # Optional stamps if you add these fields later\n    if hasattr(doc, \"intake_completed_on\") and is_empty(getattr(doc, \"intake_completed_on\", None)):\n        doc.intake_completed_on = now_datetime()\n\n    if hasattr(doc, \"intake_completed_by\") and is_empty(getattr(doc, \"intake_completed_by\", None)):\n        doc.intake_completed_by = frappe.session.user\n\n    if hasattr(doc, \"intake_complete\"):\n        doc.intake_complete = 1\n\nmain()\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-26 07:32:43.160906",
  "module": "Client Management",
  "name": "Case Number Generator",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Case",
  "script": "import re\n\ndef clean_letters(s: str) -> str:\n    if not s:\n        return \"\"\n    # keep letters only\n    return re.sub(r\"[^A-Za-z]\", \"\", s).upper()\n\nfirst = clean_letters(doc.get(\"client_first_name\") or \"\")\nlast = clean_letters(doc.get(\"client_last_name\") or \"\")\n\n# Ensure at least 2 chars each; pad with X if too short/missing\nfirst2 = (first[:2]).ljust(2, \"X\")\nlast2 = (last[:2]).ljust(2, \"X\")\n\nprefix = f\"{first2}{last2}\"\n\n# Only set once (keeps ID stable even if client name changes later)\nif not doc.get(\"case_display_id\") and doc.get(\"name\"):\n    doc.case_display_id = f\"{prefix}-{doc.name}\"\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Validate",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-26 11:59:04.676755",
  "module": "Client Management",
  "name": "Case Viewing Permissions",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Case",
  "script": "user = frappe.session.user\n\nif user == \"Administrator\" or frappe.user.has_role(\"System Manager\"):\n    conditions = \"\"\nelse:\n    user_esc = frappe.db.escape(user)\n    conditions = f\"\"\"\n    (\n        `tabHRSN Case`.program_manager = {user_esc}\n     OR `tabHRSN Case`.case_manager = {user_esc}\n     OR `tabHRSN Case`.intake_specialist = {user_esc}\n     OR `tabHRSN Case`.billing_specialist = {user_esc}\n\n     OR EXISTS (\n        SELECT 1\n        FROM `tabHRSN Staff Coverage` c\n        WHERE c.enabled = 1\n          AND c.covering_user = {user_esc}\n          AND CURDATE() BETWEEN c.start_date AND c.end_date\n          AND (\n                c.absent_user = `tabHRSN Case`.program_manager\n             OR c.absent_user = `tabHRSN Case`.case_manager\n             OR c.absent_user = `tabHRSN Case`.intake_specialist\n             OR c.absent_user = `tabHRSN Case`.billing_specialist\n          )\n     )\n    )\n    \"\"\"\n\n",
  "script_type": "Permission Query"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-29 11:06:04.777532",
  "module": "Client Management",
  "name": "W9 Verification",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Vendor W9",
  "script": "import frappe\nfrom frappe.utils import today\n\nW9_DOCTYPE = \"HRSN Vendor W9\"\nVENDOR_DOCTYPE = \"HRSN Vendor\"\n\nSTATUS_PRIORITY = [\"Verified (Active)\", \"Pending Review\", \"Rejected\"]\n\ndef get_select_options(doctype, fieldname):\n    meta = frappe.get_meta(doctype)\n    df = meta.get_field(fieldname)\n    if not df or not df.options:\n        return []\n    return [o.strip() for o in (df.options or \"\").splitlines() if o.strip()]\n\ndef pick_first_matching(options, candidates):\n    for c in candidates:\n        if c in options:\n            return c\n    return None\n\ndef map_vendor_w9_status(w9_status, vendor_options):\n    # Try to map into whatever your Vendor's select options actually are\n    mapping = {\n        \"Verified (Active)\": [\"Verified (Active)\", \"Verified\", \"Active\"],\n        \"Pending Review\": [\"Pending Review\", \"Pending\"],\n        \"Rejected\": [\"Rejected\", \"Inactive\"],\n    }\n    candidates = mapping.get(w9_status, [w9_status])\n    return pick_first_matching(vendor_options, candidates)\n\ndef get_best_w9(vendor_name):\n    order_by = \"effective_date desc, verified_on desc, w9_received_date desc, modified desc, creation desc\"\n    for status in STATUS_PRIORITY:\n        rows = frappe.get_all(\n            W9_DOCTYPE,\n            filters={\"vendor\": vendor_name, \"status\": status},\n            fields=[\"name\", \"status\", \"verified_on\", \"verified_by\", \"effective_date\", \"w9_received_date\"],\n            order_by=order_by,\n            limit_page_length=1,\n        )\n        if rows:\n            return rows[0]\n    return None\n\ndef sync_vendor_w9_summary(vendor_name):\n    if not vendor_name:\n        return\n\n    vendor_status_options = get_select_options(VENDOR_DOCTYPE, \"w9_status\")\n    best = get_best_w9(vendor_name)\n\n    if not best:\n        frappe.db.set_value(\n            VENDOR_DOCTYPE,\n            vendor_name,\n            {\"w9_status\": None, \"w9_verified_on\": None, \"w9_verified_by\": None},\n            update_modified=True,\n        )\n        return\n\n    new_vendor_status = map_vendor_w9_status(best.get(\"status\"), vendor_status_options)\n\n    summary = {\n        \"w9_status\": new_vendor_status,\n        \"w9_verified_on\": None,\n        \"w9_verified_by\": None,\n    }\n\n    if best.get(\"status\") == \"Verified (Active)\":\n        summary[\"w9_verified_on\"] = best.get(\"verified_on\")\n        summary[\"w9_verified_by\"] = best.get(\"verified_by\")\n\n    frappe.db.set_value(VENDOR_DOCTYPE, vendor_name, summary, update_modified=True)\n\n# ---- After Save logic ----\n\n# If it was set to Verified and fields are blank, stamp them once.\nif doc.status == \"Verified (Active)\":\n    updates = {}\n    if not doc.verified_on:\n        updates[\"verified_on\"] = today()\n    if not doc.verified_by:\n        updates[\"verified_by\"] = frappe.session.user\n    if updates:\n        frappe.db.set_value(W9_DOCTYPE, doc.name, updates, update_modified=False)\n\n# Always refresh vendor summary\nsync_vendor_w9_summary(doc.vendor)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Delete",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-29 11:07:07.415196",
  "module": null,
  "name": "Delete Vendor W9",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Vendor W9",
  "script": "import frappe\n\nW9_DOCTYPE = \"HRSN Vendor W9\"\nVENDOR_DOCTYPE = \"HRSN Vendor\"\nSTATUS_PRIORITY = [\"Verified (Active)\", \"Pending Review\", \"Rejected\"]\n\ndef get_select_options(doctype, fieldname):\n    meta = frappe.get_meta(doctype)\n    df = meta.get_field(fieldname)\n    if not df or not df.options:\n        return []\n    return [o.strip() for o in (df.options or \"\").splitlines() if o.strip()]\n\ndef pick_first_matching(options, candidates):\n    for c in candidates:\n        if c in options:\n            return c\n    return None\n\ndef map_vendor_w9_status(w9_status, vendor_options):\n    mapping = {\n        \"Verified (Active)\": [\"Verified (Active)\", \"Verified\", \"Active\"],\n        \"Pending Review\": [\"Pending Review\", \"Pending\"],\n        \"Rejected\": [\"Rejected\", \"Inactive\"],\n    }\n    candidates = mapping.get(w9_status, [w9_status])\n    return pick_first_matching(vendor_options, candidates)\n\ndef get_best_w9(vendor_name):\n    order_by = \"effective_date desc, verified_on desc, w9_received_date desc, modified desc, creation desc\"\n    for status in STATUS_PRIORITY:\n        rows = frappe.get_all(\n            W9_DOCTYPE,\n            filters={\"vendor\": vendor_name, \"status\": status},\n            fields=[\"name\", \"status\", \"verified_on\", \"verified_by\", \"effective_date\", \"w9_received_date\"],\n            order_by=order_by,\n            limit_page_length=1,\n        )\n        if rows:\n            return rows[0]\n    return None\n\ndef sync_vendor_w9_summary(vendor_name):\n    if not vendor_name:\n        return\n\n    vendor_status_options = get_select_options(VENDOR_DOCTYPE, \"w9_status\")\n    best = get_best_w9(vendor_name)\n\n    if not best:\n        frappe.db.set_value(\n            VENDOR_DOCTYPE,\n            vendor_name,\n            {\"w9_status\": None, \"w9_verified_on\": None, \"w9_verified_by\": None},\n            update_modified=True,\n        )\n        return\n\n    new_vendor_status = map_vendor_w9_status(best.get(\"status\"), vendor_status_options)\n\n    summary = {\n        \"w9_status\": new_vendor_status,\n        \"w9_verified_on\": None,\n        \"w9_verified_by\": None,\n    }\n\n    if best.get(\"status\") == \"Verified (Active)\":\n        summary[\"w9_verified_on\"] = best.get(\"verified_on\")\n        summary[\"w9_verified_by\"] = best.get(\"verified_by\")\n\n    frappe.db.set_value(VENDOR_DOCTYPE, vendor_name, summary, update_modified=True)\n\n# After Delete logic\nsync_vendor_w9_summary(doc.vendor)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-30 10:01:07.340711",
  "module": "Client Management",
  "name": "HRSN Client Bill - block approval without verified W9 + invoice; stamp approved fields",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Client Bill",
  "script": "import frappe\nfrom frappe.utils import nowdate\n\nVERIFIED_W9_STATUS = \"Verified (Active)\"\nAPPROVED_STATE = \"Approved\"\n\ndef get_prev_state(doc):\n    prev = doc.get_doc_before_save()\n    return prev.get(\"workflow_state\") if prev else None\n\ndef get_verified_w9_for_vendor(vendor):\n    return frappe.db.get_value(\n        \"HRSN Vendor W9\",\n        {\"vendor\": vendor, \"status\": VERIFIED_W9_STATUS, \"docstatus\": [\"!=\", 2]},\n        \"name\"\n    )\n\ndef w9_is_verified_and_matches_vendor(w9_name, vendor):\n    row = frappe.db.get_value(\n        \"HRSN Vendor W9\",\n        w9_name,\n        [\"vendor\", \"status\", \"docstatus\"],\n        as_dict=True\n    )\n    if not row or row.get(\"docstatus\") == 2:\n        return False\n    return row.get(\"vendor\") == vendor and row.get(\"status\") == VERIFIED_W9_STATUS\n\nnew_state = doc.get(\"workflow_state\")\nold_state = get_prev_state(doc)\n\n# Enforce only when transitioning INTO Approved\napproving_now = (new_state == APPROVED_STATE and old_state != APPROVED_STATE)\n\nif approving_now:\n    if not doc.get(\"vendor\"):\n        frappe.throw(\"Vendor is required before approving this bill.\")\n\n    if not doc.get(\"invoice_attachment\"):\n        frappe.throw(\"Invoice attachment is required before approving this bill.\")\n\n    if doc.get(\"vendor_w9\"):\n        if not w9_is_verified_and_matches_vendor(doc.vendor_w9, doc.vendor):\n            frappe.throw(\"Cannot approve: selected Vendor W9 is not Verified (Active) for this vendor.\")\n    else:\n        verified_w9 = get_verified_w9_for_vendor(doc.vendor)\n        if not verified_w9:\n            frappe.throw(\"Cannot approve: vendor does not have a Verified (Active) W-9 on file.\")\n        # optional convenience: auto-fill\n        doc.vendor_w9 = verified_w9\n\n    if not doc.get(\"approved_on\"):\n        doc.approved_on = nowdate()\n    if not doc.get(\"approved_by\"):\n        doc.approved_by = frappe.session.user\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-30 10:03:13.782364",
  "module": "Client Management",
  "name": "HRSN Client Vendor Payment",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Client Vendor Payment",
  "script": "import frappe\n\nPAID_STATE = \"Paid\"\nAPPROVED_BILL_STATE = \"Approved\"\n\ndef get_prev_state(doc):\n    prev = doc.get_doc_before_save()\n    return prev.get(\"workflow_state\") if prev else None\n\nnew_state = doc.get(\"workflow_state\")\nold_state = get_prev_state(doc)\n\nmarking_paid_now = (new_state == PAID_STATE and old_state != PAID_STATE)\n\n# Sync vendor (and optionally case_display_id) from bill\nif doc.get(\"bill\"):\n    bill = frappe.get_doc(\"HRSN Client Bill\", doc.bill)\n\n    if bill.get(\"vendor\"):\n        if doc.get(\"vendor\") and doc.vendor != bill.vendor:\n            frappe.throw(\"Vendor on Payment must match Vendor on the linked Bill.\")\n        doc.vendor = bill.vendor\n\n    # optional: sync case_display_id if you intend it to point to HRSN Case\n    try:\n        doc.case_display_id = bill.get(\"case_display_id\")\n    except Exception:\n        pass\n\nif marking_paid_now:\n    if not doc.get(\"bill\"):\n        frappe.throw(\"A linked Bill is required before marking a payment as Paid.\")\n\n    bill = frappe.get_doc(\"HRSN Client Bill\", doc.bill)\n\n    if bill.docstatus != 1 and bill.get(\"workflow_state\") != APPROVED_BILL_STATE:\n        frappe.throw(\"Cannot mark Paid: linked Bill is not Approved.\")\n\n    if not bill.get(\"invoice_attachment\"):\n        frappe.throw(\"Cannot mark Paid: linked Bill is missing the invoice attachment.\")\n\n    if not doc.get(\"amount_paid\") or doc.amount_paid <= 0:\n        frappe.throw(\"Amount Paid must be greater than zero.\")\n\n    if doc.get(\"payment_method\") in (\"ACH\", \"Check\") and not doc.get(\"payment_reference\"):\n        frappe.throw(\"Payment Reference is required for ACH/Check payments.\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-30 10:04:40.196845",
  "module": "Client Management",
  "name": "HRSN Client Vendor Payment-Before Submit",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Client Vendor Payment",
  "script": "import frappe\n\nPAID_STATE = \"Paid\"\nAPPROVED_BILL_STATE = \"Approved\"\n\ndef get_prev_state(doc):\n    prev = doc.get_doc_before_save()\n    return prev.get(\"workflow_state\") if prev else None\n\nnew_state = doc.get(\"workflow_state\")\nold_state = get_prev_state(doc)\n\nmarking_paid_now = (new_state == PAID_STATE and old_state != PAID_STATE)\n\n# Sync vendor (and optionally case_display_id) from bill\nif doc.get(\"bill\"):\n    bill = frappe.get_doc(\"HRSN Client Bill\", doc.bill)\n\n    if bill.get(\"vendor\"):\n        if doc.get(\"vendor\") and doc.vendor != bill.vendor:\n            frappe.throw(\"Vendor on Payment must match Vendor on the linked Bill.\")\n        doc.vendor = bill.vendor\n\n    # optional: sync case_display_id if you intend it to point to HRSN Case\n    try:\n        doc.case_display_id = bill.get(\"case_display_id\")\n    except Exception:\n        pass\n\nif marking_paid_now:\n    if not doc.get(\"bill\"):\n        frappe.throw(\"A linked Bill is required before marking a payment as Paid.\")\n\n    bill = frappe.get_doc(\"HRSN Client Bill\", doc.bill)\n\n    if bill.docstatus != 1 and bill.get(\"workflow_state\") != APPROVED_BILL_STATE:\n        frappe.throw(\"Cannot mark Paid: linked Bill is not Approved.\")\n\n    if not bill.get(\"invoice_attachment\"):\n        frappe.throw(\"Cannot mark Paid: linked Bill is missing the invoice attachment.\")\n\n    if not doc.get(\"amount_paid\") or doc.amount_paid <= 0:\n        frappe.throw(\"Amount Paid must be greater than zero.\")\n\n    if doc.get(\"payment_method\") in (\"ACH\", \"Check\") and not doc.get(\"payment_reference\"):\n        frappe.throw(\"Payment Reference is required for ACH/Check payments.\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Submit",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-30 10:05:08.124629",
  "module": "Client Management",
  "name": "HRSN Client Bill-Before Submit",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Client Bill",
  "script": "import frappe\nfrom frappe.utils import nowdate\n\nVERIFIED_W9_STATUS = \"Verified (Active)\"\nAPPROVED_STATE = \"Approved\"\n\ndef get_prev_state(doc):\n    prev = doc.get_doc_before_save()\n    return prev.get(\"workflow_state\") if prev else None\n\ndef get_verified_w9_for_vendor(vendor):\n    return frappe.db.get_value(\n        \"HRSN Vendor W9\",\n        {\"vendor\": vendor, \"status\": VERIFIED_W9_STATUS, \"docstatus\": [\"!=\", 2]},\n        \"name\"\n    )\n\ndef w9_is_verified_and_matches_vendor(w9_name, vendor):\n    row = frappe.db.get_value(\n        \"HRSN Vendor W9\",\n        w9_name,\n        [\"vendor\", \"status\", \"docstatus\"],\n        as_dict=True\n    )\n    if not row or row.get(\"docstatus\") == 2:\n        return False\n    return row.get(\"vendor\") == vendor and row.get(\"status\") == VERIFIED_W9_STATUS\n\nnew_state = doc.get(\"workflow_state\")\nold_state = get_prev_state(doc)\n\n# Enforce only when transitioning INTO Approved\napproving_now = (new_state == APPROVED_STATE and old_state != APPROVED_STATE)\n\nif approving_now:\n    if not doc.get(\"vendor\"):\n        frappe.throw(\"Vendor is required before approving this bill.\")\n\n    if not doc.get(\"invoice_attachment\"):\n        frappe.throw(\"Invoice attachment is required before approving this bill.\")\n\n    if doc.get(\"vendor_w9\"):\n        if not w9_is_verified_and_matches_vendor(doc.vendor_w9, doc.vendor):\n            frappe.throw(\"Cannot approve: selected Vendor W9 is not Verified (Active) for this vendor.\")\n    else:\n        verified_w9 = get_verified_w9_for_vendor(doc.vendor)\n        if not verified_w9:\n            frappe.throw(\"Cannot approve: vendor does not have a Verified (Active) W-9 on file.\")\n        # optional convenience: auto-fill\n        doc.vendor_w9 = verified_w9\n\n    if not doc.get(\"approved_on\"):\n        doc.approved_on = nowdate()\n    if not doc.get(\"approved_by\"):\n        doc.approved_by = frappe.session.user\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-12-30 10:05:56.113471",
  "module": "Client Management",
  "name": "HRSN Vendor W9",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "HRSN Vendor W9",
  "script": "import frappe\nfrom frappe.utils import nowdate\n\nVERIFIED_W9_STATUS = \"Verified (Active)\"\n\nprev = doc.get_doc_before_save()\nold_status = prev.get(\"status\") if prev else None\nnew_status = doc.get(\"status\")\n\nif new_status == VERIFIED_W9_STATUS:\n    if not doc.get(\"vendor\"):\n        frappe.throw(\"Vendor is required.\")\n\n    other = frappe.db.get_value(\n        \"HRSN Vendor W9\",\n        {\"vendor\": doc.vendor, \"status\": VERIFIED_W9_STATUS, \"name\": [\"!=\", doc.name], \"docstatus\": [\"!=\", 2]},\n        \"name\"\n    )\n    if other:\n        frappe.throw(f\"This vendor already has a Verified (Active) W-9 ({other}). Change that record’s status first.\")\n\n    if old_status != VERIFIED_W9_STATUS:\n        doc.verified_on = nowdate()\n        doc.verified_by = frappe.session.user\n",
  "script_type": "DocType Event"
 }
]